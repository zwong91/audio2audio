<!DOCTYPE html>
<html>
   <head>
       <title>Live Transcription</title>
   </head>
   <body>
        <h1>Transcribe Audio With Flask 2.0</h1>
        <p id="status">Connection status will go here</p>
        <p id="transcript"></p>

        <script>
            async function startTranscription() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    if (!MediaRecorder.isTypeSupported('audio/webm')) {
                        return alert('Browser not supported');
                    }

                    const mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm',
                    });

                    const socket = new WebSocket('wss://108.136.246.72:5555/transcribe');

                    socket.onopen = () => {
                        document.querySelector('#status').textContent = 'Connected';
                        mediaRecorder.addEventListener('dataavailable', async (event) => {
                            if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                                const reader = new FileReader();
                                reader.onload = () => {
                                    const base64data = reader.result.split(',')[1];
                                    const data_to_send = [[[' 只是雨滴 受什么麻烦的这还没有打雷呢 ', '下雨总让人心情沉重呢。要不要聊聊？']], "Azure-xiaoxiao", base64data];
                                    const json_data = JSON.stringify(data_to_send);
                                    socket.send(json_data);

                                };
                                reader.readAsDataURL(event.data);
                            }
                        });
                        mediaRecorder.start(500);
                    };

                    socket.onmessage = (message) => {
                        const received = message.data;
                        // 解析接收到的 JSON 数据
                        const jsonData = JSON.parse(received);
                        const history = jsonData[0];
                        const audio = jsonData[1];
                        const text = jsonData[2];
                        // 格式化输出
                        const formattedOutput = `
                            <p><strong>History:</strong> ${JSON.stringify(history)}</p>
                            <p><strong>Audio:</strong> <a href="https://108.136.246.72:5555/asset/${audio}" target="_blank">点击这里播放音频</a></p>
                            <p><strong>Payload:</strong> ${text}</p>
                            <br><br>
                        `;
                        
                        // 将格式化后的数据添加到页面上
                        document.querySelector('#transcript').innerHTML += formattedOutput;
                        };

                    socket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        document.querySelector('#status').textContent = 'WebSocket error';
                    };

                    socket.onclose = () => {
                        document.querySelector('#status').textContent = 'WebSocket connection closed';
                    };

                } catch (error) {
                    console.error('Error accessing media devices.', error);
                    alert('Error accessing media devices: ' + error.message);
                }
            }

            document.addEventListener('DOMContentLoaded', startTranscription);
        </script>
   </body>
</html>